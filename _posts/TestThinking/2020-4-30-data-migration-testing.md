---
layout: post
title: 数据迁移项目的质量保证实践
date: 2020-4-30
categories: blog
header-img: "../img/header/Home7.jpg"
tags: [测试锦囊]
description: 数据迁移项目的质量保证实践

---


## 几种常见的数据迁移项目

我经历过三次与数据迁移有关的项目。

第一次是一个运营产品的数据报表服务。由于数据库设计的历史缺陷，运营人员每查看一份报表需要10分钟到半个小时。基于性能提升的目标，我们重新设计了数据库的schema，最后将原有数据按照新的schema进行迁移。这是相对简单的数据迁移项目。

第二次是一个中台系统服务化改造的项目，数据库随着服务的拆分而拆分。由于业务本身没有多大变化，数据迁移的复杂程度也不算太高。

第三次是我目前接触过的最复杂的数据迁移项目。项目背景是这样的：

客户原本有一个A系统来支撑当前的业务，这个系统是由该领域内曾经主流的一个技术产品研发的，是一个单体应用。后来，一方面随着业务的发展，A系统已经无法支撑与日俱增的业务场景；另一方面，原本的技术产品已经过时了。所以客户找到Thoughworks来帮助他们研发一套全新的系统。

新系统的研发分为两个阶段：

* 第一阶段，只研发新增业务场景对应的功能，原有业务场景仍然需要对接旧系统，我们将新研发的系统称为B。
* 第二阶段，在B系统上继续新增业务场景，其次，将旧系统上承载的业务按照最新的场景重新梳理，在B系统的基础上升级成一个B+系统。

B系统相当于是业务演进过程中的一个中间状态，B+系统才是终极状态，数据迁移就发生在这里。我们需要将A系统的数据迁移到B+系统中来。由于业务流程、技术框架、数据类型等都不一样。数据迁移就变得异常复杂。
​
​<center>
    <img width="100%" src="{{site.baseurl }}/img/testing-on-data-migration/img-001.jpg" align="center">
</center>

本文将以第三个项目来讲述数据迁移的质量保证实践。

​
## 数据迁移的过程中的质量

数据迁移的过程是这样的。

​<center><img width="100%" src="{{site.baseurl }}/img/testing-on-data-migration/img-002.jpg" align="center"></center>
​
​我们新增了一个“data-migration”的服务，将A系统的数据导到“data-migration”的服务的DB，这个过程称为“导出”；通过一定的mapping规则，将数据导到B+系统，这个过程称为“导入”。
​
​导入
​
​导出：
​
​

数据导出的质量：数据量、数据正确性、导出的性能
数据导入的质量：数据量、数据正确性、导入的性能

Mapping 规则的质量：

1. 哪些表需要迁移、哪些表不需要迁；需要迁移的表老库和新库的对应关系是怎样的
2. 明确表的关联关系，关联表是否需要迁移，不迁移怎么处理
3. 迁移的表中，哪些字段要迁移，哪些不迁移，对应关系是怎样的
4. 新表中的字段，老表是不是一定有，如果不一定，怎么处理可能为空的情况，尤其是必填字段的处理
5. 迁移前，新表是否为空，不为空是否可能存在数据重复的情况，怎么处理
6. 新老表中的字段类型、长度的定义是否一致，可否正确转换
7. 需迁移的表数据量为多少

## 数据迁移项目的质量策略

数据迁移项目，客户关心的是什么？

1. 数据要完整地迁移到B+系统
2. 数据能够在新系统中正常工作

#### 数据层面

数据导入的成功率
2. 数据导入的正确性
数据类型
* 被归档的历史数
* 展示在报表中的历史数据
* 基础数据
* 业务数据

#### 功能层面

​<center>
    <p><img width="90%" src="{{site.baseurl }}/img/testing-on-data-migration/img-003.jpg" align="center"></p>
</center>

#### 性能层面

数据导出的性能
数据导入的性能
数据迁移到新库之后业务的性能
数据安全层面

#### 安全层面


## 数据迁移项目中的自动化测试

数据测试

抽样数据验证：按照关键业务路径抽样数据，做数据一致性对比
全量数据验证：关系数据库，直接新老数据库中jdbc方式获取数据，一条条进行对比，新老数据存在规则转换的情况需要在对账程序中同时进行规则判断。

业务功能测试

## 数据迁移项目测试的几个Tips
1. 数据迁移中的异常测试
2.  上线后怎么办
